# Tools required
### Encoding/Decoding
CyberChef -> https://gchq.github.io/CyberChef/ 

### Forensic tool to view files in hex
HxD -> https://mh-nexus.de/en/hxd/

### MicroSoft SQL Server
View and query database -> https://www.microsoft.com/en-sg/sql-server/sql-server-downloads

# Investigation notes
Files uploaded to Sharepoint in general are stored in database in hexa-decimal (varbinary).

AV or endpoint protection solution pick up malware signatures in temp folders (e.g C:\Users\<username>\AppData\Local\Temp\RESXXXX.tmp, where XXXX is alphanumeric character), and it's recurring every 3-4 hours with different file name and hash. The signature picked by Symantec Endpoint Protection is Trojan.Malscript. Upon investigation, this is due to Sharepoint Search Crawl that could be re-indexing the web application to the respective web root folder. The **_username_** is associated with the account used by the web application.

Note: We obtained the quarantined files and were able to decrypt the quarantine files as we are using Symantec Endpoint Protection AV in the environment. Kudos to Hexacorn and benleeyr! Refer to credits below.

To pinpoint the exact location of the malware, below are the steps

## 1. Identify filename
Sharepoint IIS logs were retrieved to look for malicious web request. We identified the malicious request to be from the Search Crawler via User Agent **_Mozilla/4.0+Compatible;MSIE+4.01;+Windows+NT;+MS+Search+6.0+Robot)_**, where we see malicious file names such as /webshell.aspx, /cmd.aspx, etc.

Reference: https://docs.microsoft.com/en-us/sharepoint/troubleshoot/search/crawler-ignores-directives-for-user-agent

## 2. Identify database
As the Sharepoint could be hosting multiple web applications, there could be multiple database residing in the database server. Luckily database files are not totally encoded. We inspected the database file (.mdf) in hex (e.g HxD or WinHex) to search for the file name. _Database files and database backup files are not totally encoded.
There is a search crawler database, where we found the linkage to the web application storing the malicious files.

## 3. Inspecting database
You could reload the identified database in the forensics tools again to verify if the malicious file names are inside.
**AllDocs** and **Docs** table contains the metadata of the files, including file name (**LeafName**), location (**DirName**), creation date (**TimeCreated**)

**DocStreams** table contains the payload of the web application files
- You may have to refer to the sharepoint documentation on various Sharepoint version
- In any case, you could list the database schema to search for the relevant table containing the **Content** column
```
SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME like 'Content'
```

#### 3a. Looking for the payload via filename
In the **AllDocs** table, search for the relevant file name in (**LeafName**), and note the unique ID (**Id**).
```
SELECT * FROM AllDocs WHERE LeafName LIKE '<filename>'
```
Quick tips: in SQL query, '%' is used to represent any characters, before and after.

This unique ID is linked to **DocStream** table, (**DocID**) column.
```
SELECT * FROM DocStreams WHERE DocId LIKE '<(Id) from Docs table>'
```

#### 3b. Looking for the payload via payload
We know that ASPX webshells commonly contains the keyword (Shell), and it is rarely used in real-world application, thus we can perform a search on this hex on the **DocStreams** table.
Converting "Shell" to hexadecimal to obtain 0x5368656C6C.
We can't search for the encoded string similar to step 3a as the value of the Content column is in varbinary format, thus we have to convert its type to varchar(max).
SQL query:
```
SELECT * FROM DocStreams WHERE CONVERT(varchar(max), Content,2) LIKE '%5368656C6C%'
```

## 4. Deleting the entries in database

As the database are wholly administered by the sharepoint, I urge you to bring this up with Microsoft Support to clean this up, else restore back from a known-clean state image. Rebuilding the web application/database will be the last resort.

# Credits
- https://benleeyr.wordpress.com/2021/07/15/linking-malware-in-sharepoint/
- https://benleeyr.wordpress.com/2020/04/23/dexray/
- https://www.hexacorn.com/blog/category/software-releases/dexray/
